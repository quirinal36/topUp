# 선결제 관리 플랫폼 커밍스 (Comings) - 프로젝트 현황 문서

**문서 버전:** 1.0
**작성일:** 2025-12-30
**프로젝트 상태:** MVP 개발 완료

---

## 1. 프로젝트 개요

### 1.1 프로젝트 목적
기존 구글 스프레드시트로 관리하던 선결제(예치금) 장부의 휴먼 에러를 방지하고, 실시간 잔액 조회 및 편리한 인터페이스를 통해 업무 효율을 높이는 웹 애플리케이션

### 1.2 기술 스택
| 구분 | 기술 | 버전 |
|------|------|------|
| **Frontend** | React + TypeScript | 18.2.0 |
| | Vite | 5.0.8 |
| | Tailwind CSS | 3.3.6 |
| | Zustand (상태관리) | 4.4.7 |
| | Recharts (차트) | 2.10.3 |
| **Backend** | FastAPI (Python) | 0.109.0 |
| | Uvicorn | 0.27.0 |
| **Database** | Supabase (PostgreSQL) | 2.3.4 |
| **인증** | JWT + OAuth 2.0 | - |
| **이메일** | Resend | 2.0.0 |

---

## 2. 구현 완료 기능 (Completed Features)

### 2.1 인증 및 보안

| Epic | Story | Status | 비고 |
|------|-------|--------|------|
| **소셜 로그인** | 네이버 OAuth 로그인 | ✅ 완료 | OAuth 2.0 플로우 구현 |
| | 카카오 OAuth 로그인 | ✅ 완료 | OAuth 2.0 플로우 구현 |
| | 복수 소셜 계정 연동 | ✅ 완료 | 동일 상점에 여러 소셜 계정 연결 |
| | 자동 로그인 유지 | ✅ 완료 | localStorage 토큰 저장 |
| **PIN 보안** | PIN 설정/변경 | ✅ 완료 | 4자리, bcrypt 해시 |
| | PIN 검증 API | ✅ 완료 | 5회 실패시 1분 잠금 |
| | PIN 재설정 | ✅ 완료 | 소셜 재인증 후 재설정 |
| **비밀번호 재설정** | 이메일 인증번호 발송 | ✅ 완료 | Resend API 연동 |
| | 인증번호 검증 | ✅ 완료 | 6자리, 10분 만료, 5회 제한 |
| | 새 비밀번호 설정 | ✅ 완료 | JWT 토큰 기반 검증 |

### 2.2 고객 관리

| Epic | Story | Status | 비고 |
|------|-------|--------|------|
| **고객 등록** | 신규 고객 등록 | ✅ 완료 | 이름 + 연락처 뒷자리(4자리) |
| | 중복 고객 방지 | ✅ 완료 | 동일 이름+번호 검증 |
| **고객 조회** | 고객 목록 조회 | ✅ 완료 | 페이지네이션 (20건/페이지) |
| | 실시간 검색 | ✅ 완료 | 이름/연락처 필터링 |
| | 고객 상세 조회 | ✅ 완료 | 통계 + 거래내역 포함 |
| **고객 수정** | 고객 정보 수정 | ✅ 완료 | 이름, 연락처 수정 |
| | 고객 삭제 | ✅ 완료 | 잔액 0원일 때만 가능 |

### 2.3 거래 관리

| Epic | Story | Status | 비고 |
|------|-------|--------|------|
| **충전(Charge)** | 선불 충전 | ✅ 완료 | 실결제액 + 서비스금액 |
| | 결제수단 선택 | ✅ 완료 | 카드/현금/계좌이체 |
| | 충전 비고 입력 | ✅ 완료 | 메모 기능 |
| **차감(Deduct)** | 서비스 이용 차감 | ✅ 완료 | 잔액 검증 포함 |
| | 빠른 금액 버튼 | ✅ 완료 | 3K, 5K, 10K, 15K, 20K |
| | 주문 메뉴 입력 | ✅ 완료 | 비고란 활용 |
| **취소(Cancel)** | 거래 취소 | ✅ 완료 | 역거래 생성 방식 |

### 2.4 대시보드 및 통계

| Epic | Story | Status | 비고 |
|------|-------|--------|------|
| **대시보드** | 금일 충전/차감 합계 | ✅ 완료 | 실시간 집계 |
| | 전체 예치금 현황 | ✅ 완료 | 총 잔액 표시 |
| | 등록 고객 수 | ✅ 완료 | 총 고객 수 표시 |
| **통계 분석** | 기간별 매출 차트 | ✅ 완료 | 일간/주간/월간 |
| | 상위 고객 순위 | ✅ 완료 | Top 10 + 방문횟수 |
| | 결제수단별 비율 | ✅ 완료 | 파이 차트 |
| | 인기 메뉴 분석 | ⚠️ 부분완료 | 단순 카운트 방식 |

### 2.5 UI/UX

| Epic | Story | Status | 비고 |
|------|-------|--------|------|
| **디자인** | 반응형 레이아웃 | ✅ 완료 | 모바일/태블릿 최적화 |
| | 다크 모드 | ✅ 완료 | 테마 전환 지원 |
| | 카드 기반 UI | ✅ 완료 | 가독성 향상 |
| **사용성** | 로딩 상태 표시 | ✅ 완료 | 스피너 컴포넌트 |
| | 에러 메시지 표시 | ✅ 완료 | 사용자 친화적 메시지 |
| | 잔액 부족 경고 | ✅ 완료 | 차감 전 검증 |

---

## 3. 미구현 / 개선 필요 기능 (Backlog)

### 3.1 우선순위 High (보안/안정성)

| Story | 현재 상태 | 작업 내용 | 예상 복잡도 |
|-------|----------|----------|-------------|
| PIN 검증 UI 적용 | API만 구현 | 민감 작업 시 PIN 입력 모달 표시 | M |
| 최초 로그인 PIN 설정 강제 | 미구현 | 신규 가입 시 PIN 설정 플로우 추가 | S |
| 거래 확인 다이얼로그 | 미구현 | 차감/취소 전 확인 팝업 | S |
| 토스트 알림 시스템 | 미구현 | 성공/실패 알림 통합 | M |

### 3.2 우선순위 Medium (기능 보완)

| Story | 현재 상태 | 작업 내용 | 예상 복잡도 |
|-------|----------|----------|-------------|
| 소셜 계정 연동 해제 | UI만 구현 | 연동된 소셜 계정 해제 기능 | M |
| 상점 프로필 수정 | 조회만 구현 | 상점명 등 정보 수정 | S |
| 거래내역 검색/필터 | 미구현 | 고객 상세 페이지 내 검색 | M |
| 데이터 내보내기 | 미구현 | CSV/Excel 다운로드 | M |

### 3.3 우선순위 Low (향후 로드맵)

| Story | 현재 상태 | 작업 내용 | 예상 복잡도 |
|-------|----------|----------|-------------|
| 카카오 알림톡 연동 | 미구현 | 잔액 변동 알림 발송 | XL |
| 블루투스 프린터 연동 | 미구현 | 거래 확인증 출력 | L |
| 멀티 상점 지원 | 미구현 | 프랜차이즈 통합 관리 | XL |
| 인기 메뉴 고도화 | 단순구현 | 자연어 분석/워드클라우드 | L |

---

## 4. 아키텍처 개요

### 4.1 시스템 구성도

```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend                              │
│  React + TypeScript + Vite (localhost:5173)                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │  Login  │ │Dashboard│ │Customers│ │Analytics│           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
│                    │                                         │
│              Zustand Store                                   │
│              Axios Client                                    │
└────────────────────┼────────────────────────────────────────┘
                     │ HTTP (REST API)
┌────────────────────┼────────────────────────────────────────┐
│                    ▼                                         │
│                 Backend                                      │
│  FastAPI + Python (localhost:8000)                          │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │  Auth   │ │Customer │ │  Trans  │ │Dashboard│           │
│  │ Router  │ │ Router  │ │ Router  │ │ Router  │           │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       │           │           │           │                  │
│  ┌────┴───────────┴───────────┴───────────┴────┐            │
│  │              Services Layer                  │            │
│  │  AuthService │ PinService │ (inline logic)  │            │
│  └──────────────────────┬───────────────────────┘            │
└─────────────────────────┼────────────────────────────────────┘
                          │ Supabase Client
┌─────────────────────────┼────────────────────────────────────┐
│                         ▼                                    │
│              Supabase (PostgreSQL)                          │
│  ┌─────────┐ ┌─────────────┐ ┌──────────┐ ┌────────────┐   │
│  │  shops  │ │social_accounts│ │customers│ │transactions│   │
│  └─────────┘ └─────────────┘ └──────────┘ └────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 데이터베이스 ERD

```
┌──────────────────┐       ┌─────────────────────┐
│      shops       │       │   social_accounts   │
├──────────────────┤       ├─────────────────────┤
│ id (PK)          │◄──────│ shop_id (FK)        │
│ name             │       │ id (PK)             │
│ pin_hash         │       │ provider            │
│ pin_failed_count │       │ provider_user_id    │
│ pin_locked_until │       │ email               │
│ created_at       │       │ is_primary          │
│ updated_at       │       │ created_at          │
└────────┬─────────┘       └─────────────────────┘
         │
         │ 1:N
         ▼
┌──────────────────┐       ┌─────────────────────┐
│    customers     │       │    transactions     │
├──────────────────┤       ├─────────────────────┤
│ id (PK)          │◄──────│ customer_id (FK)    │
│ shop_id (FK)     │       │ id (PK)             │
│ name             │       │ type (ENUM)         │
│ phone_suffix     │       │ amount              │
│ current_balance  │       │ actual_payment      │
│ created_at       │       │ service_amount      │
└──────────────────┘       │ payment_method      │
                           │ note                │
                           │ created_at          │
                           └─────────────────────┘
```

---

## 5. API 명세 요약

### 5.1 인증 API (`/api/auth`)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/login/{provider}/url` | OAuth 로그인 URL 반환 |
| POST | `/login/{provider}` | 소셜 로그인 처리 |
| POST | `/pin/verify` | PIN 검증 |
| POST | `/pin/change` | PIN 변경 |
| POST | `/pin/reset` | PIN 재설정 |
| POST | `/link/{provider}` | 소셜 계정 추가 연동 |
| POST | `/password-reset/request` | 비밀번호 재설정 요청 (이메일 발송) |
| POST | `/password-reset/verify` | 인증번호 검증 |
| POST | `/password-reset/confirm` | 새 비밀번호 설정 |
| GET | `/me` | 현재 상점 정보 |
| GET | `/social-accounts` | 연동된 소셜 계정 목록 |

### 5.2 고객 API (`/api/customers`)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/` | 고객 목록 (검색, 페이지네이션) |
| POST | `/` | 신규 고객 등록 |
| GET | `/{id}` | 고객 상세 (통계 포함) |
| PUT | `/{id}` | 고객 정보 수정 |
| DELETE | `/{id}` | 고객 삭제 |

### 5.3 거래 API (`/api/transactions`)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/` | 거래 내역 조회 |
| POST | `/charge` | 충전 거래 |
| POST | `/deduct` | 차감 거래 |
| POST | `/cancel` | 거래 취소 |

### 5.4 대시보드 API (`/api/dashboard`)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/summary` | 금일 요약 |
| GET | `/analytics/period` | 기간별 통계 |
| GET | `/analytics/top-customers` | 상위 고객 |
| GET | `/analytics/payment-methods` | 결제수단별 통계 |
| GET | `/analytics/popular-menus` | 인기 메뉴 |

---

## 6. 프론트엔드 페이지 구성

| 경로 | 페이지 | 주요 기능 |
|------|--------|----------|
| `/login` | 로그인 | 네이버/카카오 소셜 로그인 |
| `/` | 대시보드 | 금일 요약, 전체 현황 |
| `/customers` | 고객 목록 | 검색, 등록, 목록 조회 |
| `/customers/:id` | 고객 상세 | 잔액, 통계, 거래내역, 충전/차감 |
| `/analytics` | 통계 분석 | 차트, 순위, 비율 분석 |
| `/settings` | 설정 | 상점정보, PIN, 다크모드, 소셜계정 |

---

## 7. 테스트 현황

| 구분 | 상태 | 비고 |
|------|------|------|
| 단위 테스트 | ⚠️ 부분완료 | Race Condition 테스트 구현 |
| 부하 테스트 | ✅ 인프라 구축 | Locust 기반 부하 테스트 |
| 통합 테스트 | ❌ 미작성 | API 테스트 필요 |
| E2E 테스트 | ❌ 미작성 | Playwright/Cypress 권장 |
| 수동 테스트 | ✅ 진행중 | 기능별 수동 검증 |

### 7.1 테스트 인프라 (2026-01-18 추가)

| 구성 요소 | 파일 | 설명 |
|-----------|------|------|
| Race Condition 테스트 | `tests/race_condition_tests/test_balance_race.py` | 동시성 검증 |
| 부하 테스트 | `tests/load_tests/locustfile.py` | Locust 부하 테스트 |
| 데이터 생성기 | `tests/load_tests/generate_test_data.py` | 10만건+ 데이터 생성 |
| 테스트 대시보드 | `tests/dashboard.html` | 웹 기반 테스트 UI |
| 테스트 가이드 | `tests/README.md` | 사용법 문서 |

### 7.2 보안 강화 (2026-01-18 추가)

| 항목 | 상태 | 설명 |
|------|------|------|
| Race Condition 방지 | ✅ 완료 | 원자적 RPC 함수 적용 |
| DB 인덱스 최적화 | ✅ 완료 | 12개 인덱스 추가 |
| 데이터 무결성 | ✅ 완료 | CHECK 제약조건 추가 |
| PIN 보안 강화 | ✅ 완료 | 원자적 검증 로직 |

---

## 8. 배포 정보

### 8.1 현재 환경
- **개발 서버:** localhost (Backend: 8000, Frontend: 5173)
- **데이터베이스:** Supabase Cloud (qvsmvvgvsklhkxryhxgv)

### 8.2 배포 계획
- **타겟 플랫폼:** Vercel (Frontend), Railway/Render (Backend)
- **상태:** 미배포 (개발 환경에서 테스트 중)

---

## 9. 참고 문서

| 문서 | 위치 | 설명 |
|------|------|------|
| PRD | `/PRD.md` | 제품 요구사항 정의서 |
| 환경변수 예시 | `/backend/.env.example` | 필수 환경변수 목록 |
| API 문서 | `localhost:8000/docs` | Swagger UI (개발 환경) |

---

## 10. 담당자 및 연락처

| 역할 | 담당 | 비고 |
|------|------|------|
| 개발 | - | Full-stack |
| 기획 | - | PRD 작성 |

---

**최종 수정일:** 2026-01-18
