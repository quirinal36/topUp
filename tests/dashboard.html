<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´í˜ ì„ ê²°ì œ ì‹œìŠ¤í…œ - í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            font-size: 2rem;
        }

        h1 span {
            color: #4ecca3;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-section h2 {
            color: #4ecca3;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 0.85rem;
            color: #aaa;
        }

        .form-group input {
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card h3 {
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 .icon {
            font-size: 1.5rem;
        }

        .card p {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .card-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-inputs .form-group {
            flex: 1;
        }

        .card-inputs input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.9rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ecca3 0%, #45b393 100%);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5fd9b0 0%, #4ecca3 100%);
            transform: scale(1.02);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f5ab35 0%, #f39c12 100%);
            transform: scale(1.02);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);
            transform: scale(1.02);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.running {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #5dade2;
        }

        .status.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #58d68d;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #ec7063;
        }

        .log-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-section h2 {
            color: #4ecca3;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .log-output {
            background: #0d0d0d;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .log-output .log-entry {
            margin-bottom: 5px;
        }

        .log-output .log-time {
            color: #666;
        }

        .log-output .log-info {
            color: #5dade2;
        }

        .log-output .log-success {
            color: #58d68d;
        }

        .log-output .log-error {
            color: #ec7063;
        }

        .log-output .log-warning {
            color: #f5b041;
        }

        .clear-log-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .clear-log-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-bar .progress {
            height: 100%;
            background: linear-gradient(90deg, #4ecca3, #45b393);
            width: 0%;
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }

            .card-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ì¹´í˜ ì„ ê²°ì œ ì‹œìŠ¤í…œ <span>í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</span></h1>

        <!-- ì„¤ì • ì„¹ì…˜ -->
        <div class="config-section">
            <h2>âš™ï¸ API ì„¤ì •</h2>
            <div class="config-grid">
                <div class="form-group">
                    <label>API URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
                </div>
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="email" placeholder="test@example.com">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div class="form-group" style="justify-content: flex-end;">
                    <button class="btn btn-primary" onclick="testConnection()" id="connectBtn">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì¹´ë“œë“¤ -->
        <div class="cards">
            <!-- í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± -->
            <div class="card">
                <h3><span class="icon">ğŸ“Š</span> í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</h3>
                <p>ëŒ€ê·œëª¨ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê³ ê°ê³¼ ê±°ë˜ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. 10ë§Œê±´ ì´ìƒì˜ ë°ì´í„°ë¡œ ì‹œìŠ¤í…œ ì•ˆì •ì„±ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="card-inputs">
                    <div class="form-group">
                        <label>ê³ ê° ìˆ˜</label>
                        <input type="number" id="customerCount" value="100" min="1" max="10000">
                    </div>
                    <div class="form-group">
                        <label>ê±°ë˜ ìˆ˜</label>
                        <input type="number" id="transactionCount" value="1000" min="1" max="100000">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateTestData()" id="generateBtn">ë°ì´í„° ìƒì„± ì‹œì‘</button>
                <div class="progress-bar" id="generateProgress">
                    <div class="progress"></div>
                </div>
                <div class="status" id="generateStatus"></div>
            </div>

            <!-- Race Condition í…ŒìŠ¤íŠ¸ -->
            <div class="card">
                <h3><span class="icon">ğŸ”„</span> Race Condition í…ŒìŠ¤íŠ¸</h3>
                <p>ë™ì‹œ ìš”ì²­ìœ¼ë¡œ ì¸í•œ ì”ì•¡ ë¶ˆì¼ì¹˜ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤. ì¶©ì „/ì°¨ê°ì´ ë™ì‹œì— ë°œìƒí•´ë„ ë°ì´í„° ì •í•©ì„±ì´ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
                <div class="card-inputs">
                    <div class="form-group">
                        <label>ë™ì‹œ ìš”ì²­ ìˆ˜</label>
                        <input type="number" id="concurrentRequests" value="20" min="2" max="100">
                    </div>
                    <div class="form-group">
                        <label>í…ŒìŠ¤íŠ¸ ê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="testAmount" value="10000" min="1000" step="1000">
                    </div>
                </div>
                <button class="btn btn-warning" onclick="runRaceConditionTest()" id="raceBtn">Race Condition í…ŒìŠ¤íŠ¸</button>
                <div class="status" id="raceStatus"></div>
            </div>

            <!-- ë¶€í•˜ í…ŒìŠ¤íŠ¸ -->
            <div class="card">
                <h3><span class="icon">âš¡</span> ë¶€í•˜ í…ŒìŠ¤íŠ¸</h3>
                <p>ì‹œìŠ¤í…œì— ë¶€í•˜ë¥¼ ê°€í•˜ì—¬ ì„±ëŠ¥ì„ ì¸¡ì •í•©ë‹ˆë‹¤. ì‘ë‹µ ì‹œê°„, ì²˜ë¦¬ëŸ‰, ì˜¤ë¥˜ìœ¨ ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="card-inputs">
                    <div class="form-group">
                        <label>ë™ì‹œ ì‚¬ìš©ì</label>
                        <input type="number" id="loadUsers" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>ì§€ì† ì‹œê°„ (ì´ˆ)</label>
                        <input type="number" id="loadDuration" value="30" min="5" max="300">
                    </div>
                </div>
                <button class="btn btn-danger" onclick="runLoadTest()" id="loadBtn">ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
                <div class="progress-bar" id="loadProgress">
                    <div class="progress"></div>
                </div>
                <div class="status" id="loadStatus"></div>
            </div>

            <!-- ì”ì•¡ ì •í•©ì„± ê²€ì¦ -->
            <div class="card">
                <h3><span class="icon">âœ…</span> ì”ì•¡ ì •í•©ì„± ê²€ì¦</h3>
                <p>ëª¨ë“  ê³ ê°ì˜ ì”ì•¡ì´ ê±°ë˜ ë‚´ì—­ í•©ê³„ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ë°ì´í„° ì†ìƒ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="card-inputs">
                    <div class="form-group">
                        <label>ê²€ì¦í•  ê³ ê° ìˆ˜</label>
                        <input type="number" id="verifyCount" value="100" min="1" max="1000">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="verifyBalances()" id="verifyBtn">ì •í•©ì„± ê²€ì¦ ì‹œì‘</button>
                <div class="status" id="verifyStatus"></div>
            </div>
        </div>

        <!-- ë¡œê·¸ ì„¹ì…˜ -->
        <div class="log-section">
            <h2>ğŸ“ ì‹¤í–‰ ë¡œê·¸</h2>
            <div class="log-output" id="logOutput">
                <div class="log-entry">
                    <span class="log-time">[ì‹œì‘]</span>
                    <span class="log-info">í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. API ì„¤ì •ì„ í™•ì¸í•˜ê³  ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</span>
                </div>
            </div>
            <button class="clear-log-btn" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ
        let authToken = null;
        let shopId = null;
        let customerIds = [];

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
            log('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(elementId, message, type) {
            const status = document.getElementById(elementId);
            status.textContent = message;
            status.className = `status show ${type}`;
        }

        // API í˜¸ì¶œ í—¬í¼
        async function apiCall(endpoint, options = {}) {
            const apiUrl = document.getElementById('apiUrl').value;
            const headers = {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                ...options.headers
            };

            const response = await fetch(`${apiUrl}${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: response.statusText }));
                throw new Error(error.detail || 'ìš”ì²­ ì‹¤íŒ¨');
            }

            return response.json();
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'ì—°ê²° ì¤‘...';

            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    throw new Error('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                }

                log('ë¡œê·¸ì¸ ì‹œë„ ì¤‘...', 'info');

                const data = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                authToken = data.access_token;
                shopId = data.shop.id;

                log(`ë¡œê·¸ì¸ ì„±ê³µ! ìƒì : ${data.shop.name}`, 'success');

                // ê³ ê° ëª©ë¡ ë¡œë“œ
                await loadCustomers();

                btn.textContent = 'ì—°ê²°ë¨ âœ“';
                btn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';

            } catch (error) {
                log(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                btn.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸';
            } finally {
                btn.disabled = false;
            }
        }

        // ê³ ê° ëª©ë¡ ë¡œë“œ
        async function loadCustomers() {
            try {
                const data = await apiCall('/api/customers?page_size=100');
                customerIds = data.customers.map(c => c.id);
                log(`ê³ ê° ${customerIds.length}ëª… ë¡œë“œë¨`, 'info');
            } catch (error) {
                log(`ê³ ê° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'warning');
            }
        }

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        async function generateTestData() {
            if (!authToken) {
                log('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const progressBar = document.getElementById('generateProgress');
            const progress = progressBar.querySelector('.progress');

            btn.disabled = true;
            progressBar.classList.add('show');

            const customerCount = parseInt(document.getElementById('customerCount').value);
            const transactionCount = parseInt(document.getElementById('transactionCount').value);

            try {
                log(`ë°ì´í„° ìƒì„± ì‹œì‘: ê³ ê° ${customerCount}ëª…, ê±°ë˜ ${transactionCount}ê±´`, 'info');
                updateStatus('generateStatus', 'ê³ ê° ìƒì„± ì¤‘...', 'running');

                // ê³ ê° ìƒì„±
                let customersCreated = 0;
                const batchSize = 10;

                for (let i = 0; i < customerCount; i += batchSize) {
                    const batch = Math.min(batchSize, customerCount - i);
                    const promises = [];

                    for (let j = 0; j < batch; j++) {
                        const suffix = String(i + j).padStart(4, '0').slice(-4);
                        promises.push(
                            apiCall('/api/customers', {
                                method: 'POST',
                                body: JSON.stringify({
                                    name: `í…ŒìŠ¤íŠ¸ê³ ê°_${String(i + j).padStart(5, '0')}`,
                                    phone_suffix: suffix
                                })
                            }).then(data => {
                                customerIds.push(data.id);
                                customersCreated++;
                            }).catch(() => {})
                        );
                    }

                    await Promise.all(promises);
                    const customerProgress = (i + batch) / customerCount * 30;
                    progress.style.width = `${customerProgress}%`;
                }

                log(`ê³ ê° ${customersCreated}ëª… ìƒì„± ì™„ë£Œ`, 'success');
                updateStatus('generateStatus', 'ê±°ë˜ ìƒì„± ì¤‘...', 'running');

                // ì´ˆê¸° ì¶©ì „
                for (let i = 0; i < customerIds.length; i += batchSize) {
                    const batch = customerIds.slice(i, i + batchSize);
                    await Promise.all(batch.map(id =>
                        apiCall('/api/transactions/charge', {
                            method: 'POST',
                            body: JSON.stringify({
                                customer_id: id,
                                actual_payment: 500000,
                                service_amount: 50000,
                                payment_method: 'CASH',
                                note: 'ì´ˆê¸° ì¶©ì „'
                            })
                        }).catch(() => {})
                    ));
                }

                // ëœë¤ ê±°ë˜ ìƒì„±
                let transactionsCreated = 0;
                for (let i = 0; i < transactionCount; i += batchSize) {
                    const batch = Math.min(batchSize, transactionCount - i);
                    const promises = [];

                    for (let j = 0; j < batch; j++) {
                        const customerId = customerIds[Math.floor(Math.random() * customerIds.length)];
                        const isCharge = Math.random() < 0.4;

                        if (isCharge) {
                            promises.push(
                                apiCall('/api/transactions/charge', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        customer_id: customerId,
                                        actual_payment: (Math.floor(Math.random() * 10) + 1) * 10000,
                                        service_amount: Math.floor(Math.random() * 3) * 5000,
                                        payment_method: ['CARD', 'CASH', 'TRANSFER'][Math.floor(Math.random() * 3)],
                                        note: `í…ŒìŠ¤íŠ¸ ì¶©ì „ #${i + j}`
                                    })
                                }).then(() => transactionsCreated++).catch(() => {})
                            );
                        } else {
                            promises.push(
                                apiCall('/api/transactions/deduct', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        customer_id: customerId,
                                        amount: (Math.floor(Math.random() * 5) + 1) * 5000,
                                        note: `í…ŒìŠ¤íŠ¸ ì°¨ê° #${i + j}`
                                    })
                                }).then(() => transactionsCreated++).catch(() => {})
                            );
                        }
                    }

                    await Promise.all(promises);
                    const txProgress = 30 + ((i + batch) / transactionCount * 70);
                    progress.style.width = `${txProgress}%`;
                }

                progress.style.width = '100%';
                log(`ê±°ë˜ ${transactionsCreated}ê±´ ìƒì„± ì™„ë£Œ!`, 'success');
                updateStatus('generateStatus', `ì™„ë£Œ! ê³ ê° ${customersCreated}ëª…, ê±°ë˜ ${transactionsCreated}ê±´`, 'success');

            } catch (error) {
                log(`ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('generateStatus', `ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë°ì´í„° ìƒì„± ì‹œì‘';
            }
        }

        // Race Condition í…ŒìŠ¤íŠ¸
        async function runRaceConditionTest() {
            if (!authToken) {
                log('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                return;
            }

            if (customerIds.length === 0) {
                log('í…ŒìŠ¤íŠ¸í•  ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                return;
            }

            const btn = document.getElementById('raceBtn');
            btn.disabled = true;

            const concurrentRequests = parseInt(document.getElementById('concurrentRequests').value);
            const testAmount = parseInt(document.getElementById('testAmount').value);
            const testCustomerId = customerIds[0];

            try {
                log(`Race Condition í…ŒìŠ¤íŠ¸ ì‹œì‘: ${concurrentRequests}ê°œ ë™ì‹œ ìš”ì²­`, 'info');
                updateStatus('raceStatus', 'í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...', 'running');

                // ì´ˆê¸° ì”ì•¡ í™•ì¸
                const initialCustomer = await apiCall(`/api/customers/${testCustomerId}`);
                const initialBalance = initialCustomer.current_balance;
                log(`ì´ˆê¸° ì”ì•¡: ${initialBalance.toLocaleString()}ì›`, 'info');

                // ë™ì‹œ ì¶©ì „ í…ŒìŠ¤íŠ¸
                log('ë™ì‹œ ì¶©ì „ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...', 'info');
                const chargePromises = [];
                for (let i = 0; i < concurrentRequests; i++) {
                    chargePromises.push(
                        apiCall('/api/transactions/charge', {
                            method: 'POST',
                            body: JSON.stringify({
                                customer_id: testCustomerId,
                                actual_payment: testAmount,
                                service_amount: 0,
                                payment_method: 'CASH',
                                note: `Race test charge #${i}`
                            })
                        }).then(() => true).catch(() => false)
                    );
                }

                const chargeResults = await Promise.all(chargePromises);
                const chargeSuccesses = chargeResults.filter(r => r).length;

                // ìµœì¢… ì”ì•¡ í™•ì¸
                const finalCustomer = await apiCall(`/api/customers/${testCustomerId}`);
                const finalBalance = finalCustomer.current_balance;

                // ê²€ì¦
                const expectedBalance = initialBalance + (chargeSuccesses * testAmount);
                const isConsistent = finalBalance === expectedBalance;

                log(`ì¶©ì „ ì„±ê³µ: ${chargeSuccesses}/${concurrentRequests}`, 'info');
                log(`ìµœì¢… ì”ì•¡: ${finalBalance.toLocaleString()}ì› (ì˜ˆìƒ: ${expectedBalance.toLocaleString()}ì›)`,
                    isConsistent ? 'success' : 'error');

                if (isConsistent) {
                    updateStatus('raceStatus', `âœ… í…ŒìŠ¤íŠ¸ í†µê³¼! ì”ì•¡ ì¼ì¹˜ (${finalBalance.toLocaleString()}ì›)`, 'success');
                    log('Race Condition í…ŒìŠ¤íŠ¸ í†µê³¼! ë°ì´í„° ì •í•©ì„± ìœ ì§€ë¨', 'success');
                } else {
                    updateStatus('raceStatus', `âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì”ì•¡ ë¶ˆì¼ì¹˜`, 'error');
                    log(`Race Condition ë°œìƒ! ì˜ˆìƒ: ${expectedBalance}, ì‹¤ì œ: ${finalBalance}`, 'error');
                }

            } catch (error) {
                log(`í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('raceStatus', `ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // ë¶€í•˜ í…ŒìŠ¤íŠ¸
        async function runLoadTest() {
            if (!authToken) {
                log('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                return;
            }

            const btn = document.getElementById('loadBtn');
            const progressBar = document.getElementById('loadProgress');
            const progress = progressBar.querySelector('.progress');

            btn.disabled = true;
            progressBar.classList.add('show');

            const users = parseInt(document.getElementById('loadUsers').value);
            const duration = parseInt(document.getElementById('loadDuration').value);

            try {
                log(`ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œì‘: ${users}ëª… ì‚¬ìš©ì, ${duration}ì´ˆ`, 'info');
                updateStatus('loadStatus', 'í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...', 'running');

                const startTime = Date.now();
                const endTime = startTime + (duration * 1000);
                let totalRequests = 0;
                let successfulRequests = 0;
                let failedRequests = 0;
                let totalResponseTime = 0;

                const runUser = async () => {
                    while (Date.now() < endTime) {
                        const reqStart = Date.now();
                        try {
                            // ëœë¤ ì‘ì—… ì„ íƒ
                            const action = Math.random();
                            if (action < 0.5) {
                                await apiCall('/api/customers?page_size=20');
                            } else if (action < 0.8) {
                                await apiCall('/api/transactions?page_size=20');
                            } else {
                                await apiCall('/api/dashboard/summary');
                            }
                            successfulRequests++;
                            totalResponseTime += Date.now() - reqStart;
                        } catch {
                            failedRequests++;
                        }
                        totalRequests++;

                        // ì§§ì€ ëŒ€ê¸°
                        await new Promise(r => setTimeout(r, 100 + Math.random() * 200));
                    }
                };

                // ì‚¬ìš©ì ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                const userPromises = [];
                for (let i = 0; i < users; i++) {
                    userPromises.push(runUser());
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progressInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    const pct = Math.min((elapsed / duration) * 100, 100);
                    progress.style.width = `${pct}%`;
                }, 500);

                await Promise.all(userPromises);
                clearInterval(progressInterval);
                progress.style.width = '100%';

                // ê²°ê³¼ ê³„ì‚°
                const avgResponseTime = totalRequests > 0 ? (totalResponseTime / successfulRequests).toFixed(0) : 0;
                const rps = (totalRequests / duration).toFixed(1);
                const errorRate = ((failedRequests / totalRequests) * 100).toFixed(1);

                log(`ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!`, 'success');
                log(`ì´ ìš”ì²­: ${totalRequests}, ì„±ê³µ: ${successfulRequests}, ì‹¤íŒ¨: ${failedRequests}`, 'info');
                log(`í‰ê·  ì‘ë‹µì‹œê°„: ${avgResponseTime}ms, RPS: ${rps}, ì˜¤ë¥˜ìœ¨: ${errorRate}%`, 'info');

                updateStatus('loadStatus',
                    `ì™„ë£Œ! RPS: ${rps}, ì‘ë‹µì‹œê°„: ${avgResponseTime}ms, ì˜¤ë¥˜ìœ¨: ${errorRate}%`,
                    parseFloat(errorRate) < 5 ? 'success' : 'error');

            } catch (error) {
                log(`ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('loadStatus', `ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // ì”ì•¡ ì •í•©ì„± ê²€ì¦
        async function verifyBalances() {
            if (!authToken) {
                log('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'error');
                return;
            }

            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;

            const verifyCount = parseInt(document.getElementById('verifyCount').value);

            try {
                log(`ì”ì•¡ ì •í•©ì„± ê²€ì¦ ì‹œì‘: ìµœëŒ€ ${verifyCount}ëª…`, 'info');
                updateStatus('verifyStatus', 'ê²€ì¦ ì¤‘...', 'running');

                const customersData = await apiCall(`/api/customers?page_size=${verifyCount}`);
                const customers = customersData.customers;

                let verified = 0;
                let inconsistencies = [];

                for (const customer of customers) {
                    const txData = await apiCall(`/api/transactions?customer_id=${customer.id}&page_size=1000`);

                    let calculatedBalance = 0;
                    for (const tx of txData.transactions) {
                        if (tx.type === 'CHARGE') {
                            calculatedBalance += tx.amount;
                        } else if (tx.type === 'DEDUCT') {
                            calculatedBalance -= tx.amount;
                        }
                        // CANCELì€ ë³µì¡í•˜ë¯€ë¡œ ìƒëµ
                    }

                    if (customer.current_balance !== calculatedBalance && txData.transactions.every(t => t.type !== 'CANCEL')) {
                        inconsistencies.push({
                            name: customer.name,
                            stored: customer.current_balance,
                            calculated: calculatedBalance
                        });
                    }
                    verified++;
                }

                log(`ê²€ì¦ ì™„ë£Œ: ${verified}ëª… ê²€ì‚¬`, 'success');

                if (inconsistencies.length === 0) {
                    updateStatus('verifyStatus', `âœ… ëª¨ë“  ê³ ê° ì”ì•¡ ì •í•©ì„± í™•ì¸ (${verified}ëª…)`, 'success');
                    log('ëª¨ë“  ì”ì•¡ì´ ê±°ë˜ ë‚´ì—­ê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤!', 'success');
                } else {
                    updateStatus('verifyStatus', `âŒ ${inconsistencies.length}ê±´ ë¶ˆì¼ì¹˜ ë°œê²¬`, 'error');
                    inconsistencies.forEach(i => {
                        log(`ë¶ˆì¼ì¹˜: ${i.name} - ì €ì¥: ${i.stored.toLocaleString()}, ê³„ì‚°: ${i.calculated.toLocaleString()}`, 'error');
                    });
                }

            } catch (error) {
                log(`ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('verifyStatus', `ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ .env ê°’ ë¡œë“œ ì‹œë„ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ)
        window.onload = function() {
            const savedApiUrl = localStorage.getItem('testApiUrl');
            const savedEmail = localStorage.getItem('testEmail');

            if (savedApiUrl) document.getElementById('apiUrl').value = savedApiUrl;
            if (savedEmail) document.getElementById('email').value = savedEmail;

            // ì…ë ¥ê°’ ë³€ê²½ ì‹œ ì €ì¥
            document.getElementById('apiUrl').addEventListener('change', (e) => {
                localStorage.setItem('testApiUrl', e.target.value);
            });
            document.getElementById('email').addEventListener('change', (e) => {
                localStorage.setItem('testEmail', e.target.value);
            });
        };
    </script>
</body>
</html>
